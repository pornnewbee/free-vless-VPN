name: Check YAML Hosts + IP Pool + GFW Test

on:
  workflow_dispatch:

jobs:
  check-hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx requests

      - name: Run WS check + DNS collect + IP test
        shell: python
        run: |
          import yaml
          import httpx
          import base64
          import os
          import random
          import socket
          import time
          from pathlib import Path
          import subprocess
          import re

          NODE_DIR = "nodes"
          DNS_DOMAINS = ["m.10099.com.cn", "app.10099.com.cn"]
          DNS_ROUNDS = 40
          TEST_TIMES = 5
          TEST_PORT = 80
          TEST_PATH = "/"

          print("=== [1] WebSocket handshake check ===")

          ws_results = {}  # host -> status

          def ws_handshake(host):
              key = base64.b64encode(os.urandom(16)).decode()
              headers = {
                  "Host": host,
                  "Connection": "Upgrade",
                  "Upgrade": "websocket",
                  "Sec-WebSocket-Version": "13",
                  "Sec-WebSocket-Key": key,
                  "User-Agent": "ws-check"
              }
              url = "http://cloudflare-dns.com:2095/"
              try:
                  with httpx.Client(timeout=5) as client:
                      r = client.get(url, headers=headers)
                      return r.status_code
              except Exception as e:
                  return f"error: {e}"

          for yml_file in sorted(Path(NODE_DIR).glob("*.yml")):
              with open(yml_file, "r", encoding="utf-8") as f:
                  data = yaml.safe_load(f)

              proxies = data.get("proxies", [])
              if not isinstance(proxies, list):
                  continue

              host = None
              for proxy in proxies:
                  host = (
                      proxy
                      .get("ws-opts", {})
                      .get("headers", {})
                      .get("Host")
                  )
                  if host:
                      break

              if not host:
                  continue

              status = ws_handshake(host)
              ws_results[host] = status

              print(f"{yml_file.name}: {host} -> {status}")

          print("\n=== [2] Collect A records ===")

          ip_set = set()
          ip_re = re.compile(r"^\d+\.\d+\.\d+\.\d+$")

          for i in range(DNS_ROUNDS):
              for d in DNS_DOMAINS:
                  try:
                      out = subprocess.check_output(
                          ["dig", d, "A", "+short"],
                          text=True,
                          timeout=5
                      )
                      for line in out.splitlines():
                          if ip_re.match(line.strip()):
                              ip_set.add(line.strip())
                  except Exception:
                      pass
              time.sleep(1)

          ip_list = sorted(ip_set)
          print(f"Collected {len(ip_list)} IPs")
          for ip in ip_list:
              print("IP:", ip)

          if not ip_list:
              raise RuntimeError("No IP collected, aborting")

          print("\n=== [3] Host + random IP test (5 times each) ===")

          def test_host_ip(host, ip):
              try:
                  with socket.create_connection((ip, TEST_PORT), timeout=5) as s:
                      req = (
                          f"GET {TEST_PATH} HTTP/1.1\r\n"
                          f"Host: {host}\r\n"
                          f"User-Agent: gfw-test\r\n"
                          f"Connection: close\r\n\r\n"
                      )
                      s.sendall(req.encode())
                      data = s.recv(64)
                      if not data:
                          return "no_response"
                      if b"HTTP/" in data:
                          return data.split(b"\r\n", 1)[0].decode(errors="ignore")
                      return "unknown"
              except Exception as e:
                  return f"error"

          for host, status in ws_results.items():
              if status == 403:
                  print(f"[SKIP] {host} (403 in WS check)")
                  continue

              ip = random.choice(ip_list)
              print(f"\nHost: {host}")
              print(f"Using IP: {ip}")

              for i in range(TEST_TIMES):
                  r = test_host_ip(host, ip)
                  print(f"  try {i+1}: {r}")
                  time.sleep(1)
