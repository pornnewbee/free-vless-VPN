name: Check YAML Hosts

on:
  workflow_dispatch:

jobs:
  check-hosts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx
      - name: Check all YAML hosts
        run: |
          import yaml
          import requests
          from pathlib import Path
          
          node_dir = "nodes"
          for yml_file in Path(node_dir).glob("*.yml"):
              with open(yml_file, "r", encoding="utf-8") as f:
                  data = yaml.safe_load(f)
              hosts = set()  # 去重
              # 假设 yml 文件结构里 host 在 data["host"]
              for entry in data:
                  hosts.add(entry["host"])  # 去重
          
              for host in hosts:
                  try:
                      resp = requests.get(f"https://{host}", timeout=5)
                      print(f"{yml_file.name}: {host} -> {resp.status_code}")
                  except Exception as e:
                      print(f"{yml_file.name}: {host} -> error {e}")
        shell: python
