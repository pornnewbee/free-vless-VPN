name: Check YAML Hosts

on:
  workflow_dispatch:

jobs:
  check-hosts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx requests
      - name: Check all YAML hosts (WebSocket handshake)
        run: |
          import yaml
          import httpx
          import base64
          import os
          from pathlib import Path
      
          node_dir = "nodes"
      
          def ws_handshake(host):
              key = base64.b64encode(os.urandom(16)).decode()
              headers = {
                  "Host": host,
                  "Connection": "Upgrade",
                  "Upgrade": "websocket",
                  "Sec-WebSocket-Version": "13",
                  "Sec-WebSocket-Key": key,
                  "User-Agent": "ws-check"
              }
      
              url = "http://cloudflare-dns.com:2095/"
      
              try:
                  with httpx.Client(timeout=5) as client:
                      r = client.get(url, headers=headers)
                      return r.status_code
              except Exception as e:
                  return f"error: {e}"
      
          for yml_file in sorted(Path(node_dir).glob("*.yml")):
              with open(yml_file, "r", encoding="utf-8") as f:
                  data = yaml.safe_load(f)
      
              proxies = data.get("proxies", [])
              if not isinstance(proxies, list):
                  print(f"{yml_file.name}: proxies is not a list")
                  continue
      
              host = None
              for proxy in proxies:
                  host = (
                      proxy
                      .get("ws-opts", {})
                      .get("headers", {})
                      .get("Host")
                  )
                  if host:
                      break   # 每个文件只取一个
      
              if not host:
                  print(f"{yml_file.name}: no Host found")
                  continue
      
              status = ws_handshake(host)
      
              if status == 101:
                  print(f"{yml_file.name}: {host} -> ✅ WS OK (101)")
              else:
                  print(f"{yml_file.name}: {host} -> ❌ {status}")
        shell: python
