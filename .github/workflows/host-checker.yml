name: WS Host + DNS IP + GFW Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx

      # =========================
      # STEP 1: WS 初步测试
      # =========================
      - name: Step 1 - WS handshake test
        shell: python
        run: |
          import yaml, httpx, base64, os, json
          from pathlib import Path

          NODE_DIR = "nodes"
          OUT_FILE = "ws_results.json"

          results = {}

          def ws_handshake(host):
              key = base64.b64encode(os.urandom(16)).decode()
              headers = {
                  "Host": host,
                  "Connection": "Upgrade",
                  "Upgrade": "websocket",
                  "Sec-WebSocket-Version": "13",
                  "Sec-WebSocket-Key": key,
                  "User-Agent": "ws-check"
              }
              url = "http://cloudflare-dns.com:2095/"
              try:
                  with httpx.Client(timeout=5) as c:
                      r = c.get(url, headers=headers)
                      return r.status_code
              except Exception as e:
                  return f"error: {e}"

          print("=== WS handshake results ===")

          for yml in sorted(Path(NODE_DIR).glob("*.yml")):
              data = yaml.safe_load(open(yml, encoding="utf-8"))
              proxies = data.get("proxies", [])
              host = None

              for p in proxies:
                  host = p.get("ws-opts", {}).get("headers", {}).get("Host")
                  if host:
                      break

              if not host:
                  continue

              status = ws_handshake(host)

              # 格式化输出
              if status == 101:
                  out = f"✅ WS OK (101)"
              elif status == 403:
                  out = "❌ 403"
              elif status == 429:
                  out = "❌ 429"
              else:
                  out = f"❌ {status}"

              print(f"{yml.name}: {host} -> {out}")
              results[host] = status

          with open(OUT_FILE, "w") as f:
              json.dump(results, f, indent=2)

      # =========================
      # STEP 2: 收集 A 记录 IP
      # =========================
      - name: Step 2 - Collect A record IPs
        run: |
          DOMAINS="m.10099.com.cn app.10099.com.cn"
          ROUNDS=40

          rm -f ips.txt
          touch ips.txt

          for i in $(seq 1 $ROUNDS); do
            for d in $DOMAINS; do
              dig $d A +short | grep -E '^[0-9.]+' >> ips.txt
            done
            sleep 1
          done

          sort -u ips.txt -o ips.txt

          echo "=== Collected IPs ==="
          cat ips.txt
          echo "Total IPs: $(wc -l < ips.txt)"

      # =========================
      # STEP 3: Host + IP 实测
      # =========================
      - name: Step 3 - Host with random IP test
        shell: python
        run: |
          import json, random, socket, time

          TEST_TIMES = 5
          PORT = 80
          PATH = "/"

          ws_results = json.load(open("ws_results.json"))
          ips = [i.strip() for i in open("ips.txt") if i.strip()]

          if not ips:
              raise RuntimeError("No IPs available")

          print("=== Host + random IP test ===")

          def test(host, ip):
              try:
                  s = socket.create_connection((ip, PORT), timeout=5)
                  req = (
                      f"GET {PATH} HTTP/1.1\r\n"
                      f"Host: {host}\r\n"
                      f"User-Agent: gfw-test\r\n"
                      f"Connection: close\r\n\r\n"
                  )
                  s.sendall(req.encode())
                  data = s.recv(64)
                  s.close()
                  if not data:
                      return "no_response"
                  if b"HTTP/" in data:
                      return data.split(b"\r\n", 1)[0].decode(errors="ignore")
                  return "unknown"
              except Exception:
                  return "error"

          for host, status in ws_results.items():
              if status == 403:
                  print(f"[SKIP] {host} (403 in WS)")
                  continue

              ip = random.choice(ips)
              print(f"\nHost: {host}")
              print(f"IP: {ip}")

              for i in range(TEST_TIMES):
                  r = test(host, ip)
                  print(f"  try {i+1}: {r}")
                  time.sleep(1)
