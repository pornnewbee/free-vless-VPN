name: Check YAML Hosts

on:
  workflow_dispatch:

jobs:
  check-hosts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml httpx requests
      - name: Check all YAML hosts
        run: |
          import yaml
          import requests
          from pathlib import Path
          
          node_dir = "nodes"
          
          for yml_file in Path(node_dir).glob("*.yml"):
              with open(yml_file, "r", encoding="utf-8") as f:
                  data = yaml.safe_load(f)
          
              hosts = set()
          
              # data['proxies'] 是列表，每个 item 是字典，里面的 server 就是 host
              if "proxies" in data and isinstance(data["proxies"], list):
                  for proxy in data["proxies"]:
                      server = proxy.get("server")
                      if server:
                          hosts.add(server)  # 去重
          
              for host in hosts:
                  try:
                      resp = requests.get(f"https://{host}", timeout=5)
                      print(f"{yml_file.name}: {host} -> {resp.status_code}")
                  except Exception as e:
                      print(f"{yml_file.name}: {host} -> error {e}")
        shell: python
